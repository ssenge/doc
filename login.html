<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Login - TRT Clinic" data-de="Anmelden - TRT Clinic">Login - TRT Clinic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/custom.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white border-gray-200 px-4 lg:px-6 py-2.5">
        <div class="flex flex-wrap justify-between items-center mx-auto max-w-screen-xl">
            <a href="index.html" class="flex items-center">
                <span class="self-center text-xl font-semibold whitespace-nowrap text-blue-600">TRT Clinic</span>
            </a>
            <div class="flex items-center">
                <!-- Language Switcher -->
                <div class="relative mr-4">
                    <button id="languageDropdown" data-dropdown-toggle="languageMenu" class="text-gray-500 hover:text-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-4 py-2.5 text-center inline-flex items-center dark:text-gray-400 dark:hover:text-white border border-gray-300 bg-white" type="button">
                        <span id="currentFlag" class="mr-2">ðŸ‡ºðŸ‡¸</span>
                        <span id="currentLanguage" class="font-semibold">EN</span>
                        <svg class="w-4 h-4 ml-2" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="languageMenu" class="z-50 hidden absolute right-0 mt-2 bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-40 border border-gray-200">
                        <ul class="py-2 text-sm text-gray-700">
                            <li><a href="#" onclick="switchLanguage('en')" class="flex items-center px-4 py-2 hover:bg-gray-100 text-gray-900 font-medium">
                                <span class="mr-2">ðŸ‡ºðŸ‡¸</span>English
                            </a></li>
                            <li><a href="#" onclick="switchLanguage('de')" class="flex items-center px-4 py-2 hover:bg-gray-100 text-gray-900 font-medium">
                                <span class="mr-2">ðŸ‡©ðŸ‡ª</span>Deutsch
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Login/Register Content -->
    <section class="bg-gray-50 py-8 lg:py-16">
        <div class="flex flex-col items-center justify-center px-6 py-8 mx-auto md:h-screen lg:py-0">
            <div class="w-full bg-white rounded-lg shadow-lg md:mt-0 sm:max-w-md xl:p-0">
                <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-gray-200">
                        <button id="loginTab" class="flex-1 py-2 px-4 text-center font-medium text-blue-600 border-b-2 border-blue-600 transition-colors" onclick="showLoginForm()">
                            <span data-en="Login" data-de="Anmelden">Login</span>
                        </button>
                        <button id="registerTab" class="flex-1 py-2 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors" onclick="showRegisterForm()">
                            <span data-en="Register" data-de="Registrieren">Register</span>
                        </button>
                    </div>

                    <!-- Login Form -->
                    <div id="loginForm" class="space-y-4 md:space-y-6">
                        <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl">
                            <span data-en="Sign in to your account" data-de="Melden Sie sich in Ihrem Konto an">Sign in to your account</span>
                        </h1>
                        
                        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>
                        
                        <form class="space-y-4 md:space-y-6" onsubmit="handleLogin(event)">
                            <div>
                                <label for="loginEmail" class="block mb-2 text-sm font-medium text-gray-900">
                                    <span data-en="Your email" data-de="Ihre E-Mail">Your email</span>
                                </label>
                                <input type="email" name="email" id="loginEmail" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" placeholder="name@company.com" required="">
                            </div>
                            <div>
                                <label for="loginPassword" class="block mb-2 text-sm font-medium text-gray-900">
                                    <span data-en="Password" data-de="Passwort">Password</span>
                                </label>
                                <input type="password" name="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" required="">
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-start">
                                    <div class="flex items-center h-5">
                                        <input id="remember" aria-describedby="remember" type="checkbox" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-blue-300">
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="remember" class="text-gray-500">
                                            <span data-en="Remember me" data-de="Angemeldet bleiben">Remember me</span>
                                        </label>
                                    </div>
                                </div>
                                <a href="#" onclick="showForgotPassword()" class="text-sm font-medium text-blue-600 hover:underline">
                                    <span data-en="Forgot password?" data-de="Passwort vergessen?">Forgot password?</span>
                                </a>
                            </div>
                            <button type="submit" id="loginButton" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">
                                <span data-en="Sign in" data-de="Anmelden">Sign in</span>
                            </button>
                        </form>
                    </div>

                    <!-- Register Form -->
                    <div id="registerForm" class="space-y-4 md:space-y-6 hidden">
                        <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl">
                            <span data-en="Create your account" data-de="Erstellen Sie Ihr Konto">Create your account</span>
                        </h1>
                        
                        <div id="registerError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>
                        <div id="registerSuccess" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"></div>
                        
                        <form class="space-y-4 md:space-y-6" onsubmit="handleRegister(event)">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="firstName" class="block mb-2 text-sm font-medium text-gray-900">
                                        <span data-en="First name" data-de="Vorname">First name</span>
                                    </label>
                                    <input type="text" name="firstName" id="firstName" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" placeholder="John" required="">
                                </div>
                                <div>
                                    <label for="lastName" class="block mb-2 text-sm font-medium text-gray-900">
                                        <span data-en="Last name" data-de="Nachname">Last name</span>
                                    </label>
                                    <input type="text" name="lastName" id="lastName" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" placeholder="Doe" required="">
                                </div>
                            </div>
                            <div>
                                <label for="registerEmail" class="block mb-2 text-sm font-medium text-gray-900">
                                    <span data-en="Your email" data-de="Ihre E-Mail">Your email</span>
                                </label>
                                <input type="email" name="email" id="registerEmail" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" placeholder="name@company.com" required="">
                            </div>
                            <div>
                                <label for="registerPassword" class="block mb-2 text-sm font-medium text-gray-900">
                                    <span data-en="Password" data-de="Passwort">Password</span>
                                </label>
                                <input type="password" name="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" required="">
                                <div id="passwordRequirements" class="mt-2 text-xs text-gray-600">
                                    <span data-en="Password must be at least 8 characters with uppercase, lowercase, and numbers" data-de="Passwort muss mindestens 8 Zeichen mit GroÃŸ-, Kleinbuchstaben und Zahlen enthalten">Password must be at least 8 characters with uppercase, lowercase, and numbers</span>
                                </div>
                            </div>
                            <div>
                                <label for="confirmPassword" class="block mb-2 text-sm font-medium text-gray-900">
                                    <span data-en="Confirm password" data-de="Passwort bestÃ¤tigen">Confirm password</span>
                                </label>
                                <input type="password" name="confirmPassword" id="confirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" required="">
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="terms" aria-describedby="terms" type="checkbox" class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-blue-300" required="">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="terms" class="font-light text-gray-500">
                                        <span data-en="I accept the " data-de="Ich akzeptiere die ">I accept the </span>
                                        <a class="font-medium text-blue-600 hover:underline" href="#">
                                            <span data-en="Terms and Conditions" data-de="Allgemeinen GeschÃ¤ftsbedingungen">Terms and Conditions</span>
                                        </a>
                                    </label>
                                </div>
                            </div>
                            <button type="submit" id="registerButton" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">
                                <span data-en="Create account" data-de="Konto erstellen">Create account</span>
                            </button>
                        </form>
                    </div>

                    <!-- Forgot Password Form -->
                    <div id="forgotPasswordForm" class="space-y-4 md:space-y-6 hidden">
                        <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl">
                            <span data-en="Reset your password" data-de="Passwort zurÃ¼cksetzen">Reset your password</span>
                        </h1>
                        
                        <div id="forgotPasswordError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>
                        <div id="forgotPasswordSuccess" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg"></div>
                        
                        <form class="space-y-4 md:space-y-6" onsubmit="handleForgotPassword(event)">
                            <div>
                                <label for="forgotEmail" class="block mb-2 text-sm font-medium text-gray-900">
                                    <span data-en="Your email" data-de="Ihre E-Mail">Your email</span>
                                </label>
                                <input type="email" name="email" id="forgotEmail" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-blue-600 focus:border-blue-600 block w-full p-2.5" placeholder="name@company.com" required="">
                            </div>
                            <button type="submit" id="forgotPasswordButton" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors">
                                <span data-en="Send reset link" data-de="Reset-Link senden">Send reset link</span>
                            </button>
                            <button type="button" onclick="showLoginForm()" class="w-full text-blue-600 bg-white hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg border border-blue-600 text-sm px-5 py-2.5 text-center transition-colors">
                                <span data-en="Back to login" data-de="ZurÃ¼ck zur Anmeldung">Back to login</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script src="assets/js/language.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/supabase-client.js"></script>
    <script>
        // Form switching functions
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            
            // Update tab styles
            document.getElementById('loginTab').className = 'flex-1 py-2 px-4 text-center font-medium text-blue-600 border-b-2 border-blue-600 transition-colors';
            document.getElementById('registerTab').className = 'flex-1 py-2 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            
            // Update tab styles
            document.getElementById('loginTab').className = 'flex-1 py-2 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors';
            document.getElementById('registerTab').className = 'flex-1 py-2 px-4 text-center font-medium text-blue-600 border-b-2 border-blue-600 transition-colors';
        }

        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
        }

        // Authentication handlers
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');
            const errorDiv = document.getElementById('loginError');
            
            // Clear previous errors
            errorDiv.classList.add('hidden');
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<span data-en="Signing in..." data-de="Anmelden...">Signing in...</span>';
            
            try {
                // Wait for Supabase to be ready
                await waitForSupabase();
                
                const result = await window.eDocAuth.signIn(email, password);
                
                if (result.success) {
                    // Redirect to dashboard or return to previous page
                    const returnUrl = new URLSearchParams(window.location.search).get('return') || 'dashboard.html';
                    window.location.href = returnUrl;
                } else {
                    showError('loginError', result.error);
                }
            } catch (error) {
                showError('loginError', 'An unexpected error occurred. Please try again.');
                console.error('Login error:', error);
            } finally {
                // Reset button
                button.disabled = false;
                button.innerHTML = '<span data-en="Sign in" data-de="Anmelden">Sign in</span>';
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const button = document.getElementById('registerButton');
            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            
            // Clear previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showError('registerError', 'Passwords do not match');
                return;
            }
            
            // Validate email
            if (!window.eDocUtils?.validateEmail(email)) {
                showError('registerError', 'Please enter a valid email address');
                return;
            }
            
            // Validate password
            const passwordValidation = window.eDocUtils?.validatePassword(password);
            if (passwordValidation && !passwordValidation.isValid) {
                showError('registerError', passwordValidation.errors.join('\n'));
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<span data-en="Creating account..." data-de="Konto wird erstellt...">Creating account...</span>';
            
            try {
                // Wait for Supabase to be ready
                await waitForSupabase();
                
                const result = await window.eDocAuth.signUp(email, password, {
                    full_name: `${firstName} ${lastName}`,
                    preferred_language: window.eDocLanguage?.getCurrentLanguage() || 'en'
                });
                
                if (result.success) {
                    // Create user profile
                    if (result.user) {
                        const profileResult = await window.eDocDatabase.createUserProfile(result.user.id, {
                            email: email,
                            first_name: firstName,
                            last_name: lastName,
                            preferred_language: window.eDocLanguage?.getCurrentLanguage() || 'en',
                            created_at: new Date().toISOString()
                        });
                        
                        if (!profileResult.success) {
                            console.warn('Failed to create user profile:', profileResult.error);
                        }
                    }
                    
                    showSuccess('registerSuccess', 'Account created successfully! Please check your email to verify your account.');
                    
                    // Switch to login form after a delay
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('loginEmail').value = email;
                    }, 3000);
                } else {
                    showError('registerError', result.error);
                }
            } catch (error) {
                showError('registerError', 'An unexpected error occurred. Please try again.');
                console.error('Registration error:', error);
            } finally {
                // Reset button
                button.disabled = false;
                button.innerHTML = '<span data-en="Create account" data-de="Konto erstellen">Create account</span>';
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;
            const button = document.getElementById('forgotPasswordButton');
            const errorDiv = document.getElementById('forgotPasswordError');
            const successDiv = document.getElementById('forgotPasswordSuccess');
            
            // Clear previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            // Validate email
            if (!window.eDocUtils?.validateEmail(email)) {
                showError('forgotPasswordError', 'Please enter a valid email address');
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<span data-en="Sending..." data-de="Wird gesendet...">Sending...</span>';
            
            try {
                // Wait for Supabase to be ready
                await waitForSupabase();
                
                const result = await window.eDocAuth.resetPassword(email);
                
                if (result.success) {
                    showSuccess('forgotPasswordSuccess', 'Password reset link sent! Please check your email.');
                } else {
                    showError('forgotPasswordError', result.error);
                }
            } catch (error) {
                showError('forgotPasswordError', 'An unexpected error occurred. Please try again.');
                console.error('Password reset error:', error);
            } finally {
                // Reset button
                button.disabled = false;
                button.innerHTML = '<span data-en="Send reset link" data-de="Reset-Link senden">Send reset link</span>';
            }
        }

        // Utility functions
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function waitForSupabase() {
            return new Promise((resolve) => {
                const checkSupabase = () => {
                    if (window.eDocAuth && window.eDocDatabase) {
                        resolve();
                    } else {
                        setTimeout(checkSupabase, 100);
                    }
                };
                checkSupabase();
            });
        }

        // Language dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownButton = document.getElementById('languageDropdown');
            const dropdownMenu = document.getElementById('languageMenu');
            
            if (dropdownButton && dropdownMenu) {
                dropdownButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropdownMenu.classList.toggle('hidden');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                        dropdownMenu.classList.add('hidden');
                    }
                });
                
                // Close dropdown when selecting a language
                dropdownMenu.addEventListener('click', function() {
                    dropdownMenu.classList.add('hidden');
                });
            }

            // Check if user is already logged in
            waitForSupabase().then(async () => {
                const user = await window.eDocAuth.getCurrentUser();
                if (user) {
                    // User is already logged in, redirect to dashboard
                    const returnUrl = new URLSearchParams(window.location.search).get('return') || 'dashboard.html';
                    window.location.href = returnUrl;
                }
            });
        });
    </script>
</body>
</html> 